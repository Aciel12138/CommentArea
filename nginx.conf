# nginx.conf 配置文件 for Windows
# Windows 下不需要指定 user 指令
# user nginx;
# 工作进程数，通常设置为CPU核心数
worker_processes auto;

# Windows 下的日志路径
error_log logs/error.log warn;
# 进程PID文件
pid logs/nginx.pid;

# 工作模式及连接数上限
events {
    # 单个后台worker process进程的最大并发链接数
    worker_connections 1024;
}

# http服务器相关设置
http {
    # 文件扩展名与文件类型映射表
    include mime.types;
    
    # 默认文件类型
    default_type application/octet-stream;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for"';
                   
    # 访问日志
    access_log logs/access.log main;
    
    # 是否调用sendfile函数（zero copy 方式）来输出文件
    sendfile on;
    
    # 连接超时时间
    keepalive_timeout 65;
    
    # gzip压缩功能
    gzip on;
    
    # 配置前端静态资源服务器
    server {
        # 监听80端口
        listen 80;
        
        # 服务器IP地址
        server_name 10.13.211.92 localhost;
        
        # Windows 下的静态文件根目录，假设将前端文件放在 nginx 安装目录下的 html 文件夹中
        root html;
        
        # 默认首页
        index index.html index.htm;
        
        # 匹配前端静态资源
        location / {
            # 首页和其他页面
            try_files $uri $uri/ =404;
        }
        
        # 提供静态图片资源访问
        location /static/ {
            alias "D:/code/SpringBoot/commentArea/static/";
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # 反向代理API请求到后端Spring Boot应用
        location /api/ {
            # 代理到后端Spring Boot服务
            proxy_pass http://10.13.211.92:8081/api/;
            
            # 设置HTTP版本为1.1
            proxy_http_version 1.1;
            
            # 设置请求头
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 代理连接超时时间
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
        
        # 错误页面
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        
        location = /50x.html {
            root html;
        }
    }
}